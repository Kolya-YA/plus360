{{ $panoSrc := default (.Get 0) (.Get "dir") }}
{{ $panoId := default (lower $panoSrc | replaceRE "[^a-z0-9]" "") (.Get "id") }}
{{ $previewImg := .Page.Resources.GetMatch (printf "*%s*" $panoSrc) }}
{{ $clickToLoadBtn := $.Site.Params.clickToLoadBtn }}

<div class="pano360">
  <div id="{{ $panoId }}" class="pano360__pano"></div>
  {{ with .Get "caption" }}<p class="pano360__caption">{{ . }}</p>{{ end -}}
  
  {{ with .Get "extLink" }}<p>
    <a class="pano360__ext-link" href="{{ . }}" target="_blank" rel="noopener">Link to view on external site</a>
  </p>{{ end }}
</div>

<script>
  fetch("/multires/{{ $panoSrc }}/config.json")
    .then(resp => resp.json())
    .then(config => {
      config.multiRes.basePath = "/multires/{{ $panoSrc }}"
      pannellum.viewer('{{ $panoId }}', {
        ...config,
        {{ with .Get "yaw" }}"yaw": {{ . }},{{ end }}
        {{ with .Get "pitch" }}"pitch": {{ . }},{{ end }}
        {{ with .Get "autoLoad" }}"autoLoad": true,{{ end }}
        {{ with .Get "title" }}"title": {{ . }},{{ end }}
        {{ with .Get "author" }}"author": {{ . }},{{ end }}
        {{ with $previewImg }}
        "preview": {{ .RelPermalink }},
        "autoLoad": false,
        {{ end }}
        {{ with $clickToLoadBtn }}
        "strings": {
          "loadButtonLabel": "{{ . }}",
        }
        {{ end }}
      })
    })
</script>